% /*
%  * @Descripttion: 
%  * @version: 
%  * @Author: Ke Wang
%  * @Date: 2024-07-06 09:15:22
%  * @LastEditors: Ke Wang
%  * @LastEditTime: 2024-07-06 16:58:39
%  */
model.pipe = [																																																																																																																																																																																																														
	% from_node	to_node	length(m)	diameter(m)	roughness	conductivity	Mmin	Mmax																																																																																																																																																																																																						
	69	2	5328	1.2	4.00E-04	2.08776	0	5000																																																																																																																																																																																																						
	2	3	5650	0.5	4.00E-04	2.08917	0	5000																																																																																																																																																																																																						
	2	4	7664	1.1	4.00E-04	2.08788	0	5000																																																																																																																																																																																																						
	4	5	1461	0.4	4.00E-04	2.08884	0	5000																																																																																																																																																																																																						
	4	6	1099	0.7	4.00E-04	2.0884	0	5000																																																																																																																																																																																																						
	4	7	910	1.1	0.0004	2.08797	0	5000																																																																																																																																																																																																						
	7	8	705	1.1	0.0004	2.08799	0	5000																																																																																																																																																																																																						
	8	9	973	1.1	0.0004	2.08801	0	5000																																																																																																																																																																																																						
	9	10	618	1.1	0.0004	2.08839	0	5000																																																																																																																																																																																																						
	10	11	1739	0.6	0.0004	2.08982	0	5000																																																																																																																																																																																																						
	9	12	1793	1.1	0.0004	2.08804	0	5000																																																																																																																																																																																																						
	12	13	405	0.35	0.0004	2.08817	0	5000																																																																																																																																																																																																						
	12	14	312	1.1	0.0004	2.08809	0	5000																																																																																																																																																																																																						
	14	15	350	1.1	0.0004	2.08808	0	5000																																																																																																																																																																																																						
	15	16	922	1.1	0.0004	2.08812	0	5000																																																																																																																																																																																																						
	16	17	737.5	0.8	0.0004	2.08817	0	5000																																																																																																																																																																																																						
	17	18	423.26	0.6	0.0004	2.08821	0	5000																																																																																																																																																																																																						
	18	19	315	0.6	0.0004	2.08824	0	5000																																																																																																																																																																																																						
	19	20	600	0.45	0.0004	2.08828	0	5000																																																																																																																																																																																																						
	20	21	231	0.6	0.0004	2.08832	0	5000																																																																																																																																																																																																						
	21	22	169	0.6	0.0004	2.08835	0	5000																																																																																																																																																																																																						
	22	23	64	0.6	0.0004	2.08836	0	5000																																																																																																																																																																																																						
	23	24	100	0.6	0.0004	2.08839	0	5000																																																																																																																																																																																																						
	24	25	125	0.6	0.0004	2.08841	0	5000																																																																																																																																																																																																						
	25	26	166	0.6	0.0004	2.08852	0	5000																																																																																																																																																																																																						
	26	27	532	0.25	0.0004	2.08895	0	5000																																																																																																																																																																																																						
	26	28	967	0.6	0.0004	2.08814	0	5000																																																																																																																																																																																																						
	55	49	354	0.5	0.0004	2.08703	0	5000																																																																																																																																																																																																						
	53	54	134.5	0.45	0.0004	2.10099	0	5000																																																																																																																																																																																																						
	51	53	281	1.1	0.0004	2.10097	0	5000																																																																																																																																																																																																						
	51	52	491	0.5	0.0004	2.10112	0	5000																																																																																																																																																																																																						
	50	51	296.8	1.1	0.0004	2.10098	0	5000																																																																																																																																																																																																						
	49	50	520	1.2	0.0004	2.101	0	5000																																																																																																																																																																																																						
	45	49	334	1.2	0.0004	2.10102	0	5000																																																																																																																																																																																																						
	44	45	109	1.2	0.0004	2.10103	0	5000																																																																																																																																																																																																						
	45	47	145	0.2	0.0004	2.10116	0	5000																																																																																																																																																																																																						
	43	44	373	1	0.0004	2.10105	0	5000																																																																																																																																																																																																						
	45	46	225.14	0.25	0.0004	2.10123	0	5000																																																																																																																																																																																																						
	45	48	813.2	0.2	0.0004	2.10251	0	5000																																																																																																																																																																																																						
	41	43	46.2	1	0.0004	2.10106	0	5000																																																																																																																																																																																																						
	41	42	204	0.25	0.0004	2.10115	0	5000																																																																																																																																																																																																						
	38	41	228.45	1	0.0004	2.10107	0	5000																																																																																																																																																																																																						
	38	39	115	0.35	0.0004	2.10113	0	5000																																																																																																																																																																																																						
	38	40	92	0.35	0.0004	2.1011	0	5000																																																																																																																																																																																																						
	36	38	388	0.9	0.0004	2.10109	0	5000																																																																																																																																																																																																						
	68	36	175	1	0.0004	2.10112	0	5000																																																																																																																																																																																																						
	67	66	281.2	1	0.0004	2.1012	0	5000																																																																																																																																																																																																						
	66	65	314.33	1	0.0004	2.10121	0	5000																																																																																																																																																																																																						
	65	64	72	1	0.0004	2.10121	0	5000																																																																																																																																																																																																						
	64	63	575	1	0.0004	2.10123	0	5000																																																																																																																																																																																																						
	63	62	244	1	0.0004	2.10125	0	5000																																																																																																																																																																																																						
	62	60	94	0.6	0.0004	2.10126	0	5000																																																																																																																																																																																																						
	60	61	250	0.5	0.0004	2.10128	0	5000																																																																																																																																																																																																						
	60	59	76	0.5	0.0004	2.10127	0	5000																																																																																																																																																																																																						
	37	62	909.38	0.9	0.0004	2.1013	0	5000																																																																																																																																																																																																						
	1	37	536	0.9	0.0004	2.10137	0	5000																																																																																																																																																																																																						
	28	1	51	0.6	0.0004	2.1014	0	5000																																																																																																																																																																																																						
	28	29	85	0.6	0.0004	2.10141	0	5000																																																																																																																																																																																																						
	28	30	97	0.6	0.0004	2.10161	0	5000																																																																																																																																																																																																						
	31	32	244.1	0.6	0.0004	2.10144	0	5000																																																																																																																																																																																																						
	32	33	144	0.3	0.0004	2.10158	0	5000																																																																																																																																																																																																						
	32	34	332	0.6	0.0004	2.10155	0	5000																																																																																																																																																																																																						
	34	35	413.5	0.6	0.0004	2.10174	0	5000																																																																																																																																																																																																						
	59	58	253	0.5	0.0004	2.10131	0	5000																																																																																																																																																																																																						
	58	57	90	0.5	0.0004	2.10137	0	5000																																																																																																																																																																																																						
	57	56	143.3	0.5	0.0004	2.10146	0	5000																																																																																																																																																																																																						
	56	55	197.5	0.5	0.0004	2.10175	0	5000																																																																																																																																																																																																						
	28	31	36	0.6	0.0004	2.10254	0	5000																																																																																																																																																																																																						
	35	36	36.5	0.7	0.0004	2.0881	0	5000																																																																																																																																																																																																						
];

% node 类型1是负荷节点、类型2是非平衡热源节点、类型0是平衡热源节点																																																																																																																																																																																																													
model.node = [																																																																																																																																																																																																														
	% node	load(kJ)	Tsmin	Tsmax	Trmin	Trmax	Prmin	Prmax type																																																																																																																																																																																																					
	1	1 	0	100	0	100	-Inf	Inf	1																																																																																																																																																																																																					
	2	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	3	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	4	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																					
	5	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	6	1	0	100	0	100	-Inf	Inf 1 																																																																																																																																																																																																						
	7	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	8	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	9	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	10	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	11	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	12	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	13	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	14	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	15	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	16	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	17	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	18	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	19	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	20	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	21	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	22	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	23	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	24	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	25	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	26	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	27	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	28	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	29	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	30	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	31	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	32	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	33	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	34	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	35	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	36	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	37	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	38	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	39	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	40	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	41	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	42	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	43	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	44	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	45	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	46	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	47	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	48	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																					
	49	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	50	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	51	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	52	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	53	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	54	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	55	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	56	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	57	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	58	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	59	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	60	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	61	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	62	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	63	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	64	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	65	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	66	1	0	100	0	100	-Inf	Inf 1																																																																																																																																																																																																						
	67	1	0	100	0	100	-Inf	Inf 2																																																																																																																																																																																																						
	68	1	0	100	0	100	-Inf	Inf 2																																																																																																																																																																																																						
	69	1	0	100	0	100	-Inf	Inf 0																																																																																																																																																																																																						
];			


model.water_c = 4.2e3; % (J*kg^(-1)*K^(-1))																																																																																																																																																																																																														
model.water_dens = 1e3; %(kg*m^(-3))																																																																																																																																																																																																														
model.Pbase	=	1e6;	%	base	
model.g = 9.81; % Gravitational acceleration
model.viscosity=.294e-6; % temp is 100deg,unit:m2/s kinematic viscosity

[pipe,node,Cp,rho,Pbase,g,viscosity] = deal(model.pipe,model.node,model.water_c,model.water_dens,model.Pbase,model.g,model.viscosity);
nnodes = length(node(:,1));
npipes = length(pipe(:,1));
nloads = 0;
for i = 1:nnodes
    if node(i,9) == 1
        nloads = nloads + 1;
    end
end

D = pipe(:,4);
lamda = pipe(:,6); 
% R = 1./lamda; % heat resistance
rough = pipe(:,5);
s = pi*D.*D/4; % area of cross-section of pipe   
len = pipe(:,3);

% network incidence matrix Ah
A = [];
for i = 1:npipes
    A = [A; pipe(i,1) i -1];
end
for i = 1:npipes
    A = [A; pipe(i,2) i 1];
end
A=A';  
Ah = sparse(A(1,:),A(2,:),A(3,:),nnodes,npipes);

Aa = full(Ah);
index_refNode = find(node(:,9) == 0); % reference node
Aa(index_refNode,:) = []; % basic node-branch incidence matrix

nloops = 2 - nnodes + npipes -1; % number of basic loops; Euler's Planar Formula

if nloops > 1e-06 
	isAnnular = 1; % Annular network
	isDendritic = 0;
	Arref = rref(Aa); % Reduced row echelon form
	At = Arref; % block matrix A ~ [At Al]
	Al = Arref;
	index_t = find(sum(abs(Arref)) == 1); % the column index of At and Bt
	index_l = setdiff(1:npipes,index_t); % the column index of Al and Al_b_l
	At(:,index_l) = []; % tree matrix
	Al(:,index_t) = []; % lian zhi matrix
	Bt = (-At\Al)'; % Bt' = -At\Al
	% change the column order
	Bh = zeros(npipes-rank(Aa),npipes);
	Bh(:,index_t) = Bt;
	Bh(:,index_l) = eye(numel(index_l));
else 
	isAnnular = 0;
	isDendritic = 1; % Dendritic network
	Bh = 0;
end
% test = 0?
% verify = Aa*Bh'; 

% Phi load
Phi = -[10.0294448	9.957627727	40.273569375	13.10859375	11.393594125	10.923405292	2.343467	5.127948	10.021023333	13.09284013	20.405475779	6.8384421	3.187027754	44.06466183	0.094882667	2.3901983	2.06179995	2.482797158	3.764163375	0.695273367	5.7730113	2.376980375	2.930970992	5.905707488	7.852104925	8.6056397	7.272569967	1.201022375	0.7732263	5.063259234	50.8837266	6.75106659	28.33800991	5.64171148	8.965308196	7.086144086	2.059494	25.58327568	7.388423982	3.10164321	4.07140726	13.15310534	6.009421514	8.74262627	10.9273357	8.317739864	8.028660155	7.694059215	12.673768	11.01184383	5.346804418	8.556597763	27.45703723	9.469866555	2.347831324	23.47174068	3.731597295	4.793815673	2.123330851	5.818911986	2.782336939	28.27255014	29.89465381	6.255552299	11.91517176	13.20652273]';
